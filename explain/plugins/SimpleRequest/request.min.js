/**
 * 根据个人的编程习惯，封装的一个微信小程序网络请求框架。
 * 为的就是降低代码的偶合，提高代码的可维护性。
 * @author huangxunyue <h88305@qq.com>
 */var Config=require("config.js")||{},hexMd5=require("md5.js"),requestQueue=[],requestCookie="";wx.SQ=wx.SQ||function(E,h){function F(a){function b(a,c){var d=c.indexOf(".");if(0<d){var e=c.substr(0,d);return a[e]?b(a[e],c.substr(d+1)):!1}return a[c]||!1}function d(a,b,c,e){a=a||{};var f=c.indexOf(".");if(0<f){var h=c.substr(0,f);a[h]=d(a[h],b,c.substr(f+1),e)}else a[c]=(e||l&&1<g)&&null!=a[c]&&"object"==typeof a[c]&&0<a[c].length?a[c].concat(b):b;return a}if("object"==typeof h&&"object"==typeof a&&0<n.length){var e=h.data,f;for(f in n)var k=n[f],m=b(a,k.name),e=d(e,m,k.alias,k.merge);h.setData(e)}}function v(a,b){a=a.lastIndexOf("/")===a.length-1?a:a+"/";b=0===b.indexOf("/")?b.substr(1):b;return a+b}function w(){return wx.getStorageSync("_request_global_param_")||{}}var b={},e={url:null,data:{}},G=Config.contentType,x=Config.saveCookie||!1,B=Config.requestSign||!1,k=Config.signParamName||"sign",y=Config.pageParamName||"page",z=Config.pageSizeParamName||"pageSize",C=Config.isOffset||!1,g=1,m=10,A=null,f=!0,l=!1,p=[],n=[],q=null,r=null,t=null,u=0,D="\u73a9\u547d\u52a0\u8f7d\u4e2d";h=h||{};b.url=function(a){if(a){var c=Config.urlBase;c[a]?(e.url=v(v(Config.domain,Config.commonUrl),c[a].url),p=c[a].param||[]):e.url=/^[A-Za-z]+:\/\//.test(a)?a:v(Config.domain,a);return b}return e.url};b.pageObject=function(a){h=a;return b};b.sign=function(a,c,d){B=a?!0:!1;k=c||k;return b};b.paging=function(a,c,d){l=!0;m=a||10;y=c||y;z=d||z;!1!==arguments[arguments.length-1]&&(h.onPullDownRefresh=function(){b.pagingRefresh()},h.onReachBottom=function(){b.pagingLoading()});return b.page(g).param(z,m)};b.offset=function(a,c,d){C=!0;return b.paging(a,c,d)};b.pagingWhere=function(a){"function"==typeof a&&(A=a);return b};b.pagingRefresh=function(a){l&&(b.page(1).run(a),wx.stopPullDownRefresh())};b.pagingLoading=function(a){l&&f&&b.run(a)};b.currentPage=function(){return g};b.page=function(a){g=1<a?a:1;f=1==g?!0:f;return b.param(y,C?(g-1)*m:g)};b.nextPage=function(a){g+=a||1;return b.page(g)};b.prevPage=function(a){g+=a||1;return b.page(g)};b.param=function(a,c){e.data=e.data||{};e.data[a]=c;return b};b.params=function(){for(var a in arguments)p[a]&&b.param(p[a],arguments[a]);return b};b.paramObject=function(a,c){if("object"==typeof a)for(var d in a)!0===c?b.param(p[d],a[d]):b.param(d,a[d]);return b};b.getParam=function(a){return a?e.data[a]:e.data};b.removeParam=function(a){e.data&&e.data[a]&&delete e.data[a];return b};b.globalParam=function(a,c){var d=w();d[a]=c;wx.setStorageSync("_request_global_param_",d);return b.param(a,c)};b.removeGlobalParam=function(a,c){var d=w();!c&&d[a]&&(delete d[a],wx.setStorageSync("_request_global_param_",d));return b.removeParam(a)};b.assign=function(){var a=!0===arguments[arguments.length-1]?!0:!1,c;for(c in arguments){var d=arguments[c];d&&"string"==typeof d&&(d=d.split(":"),n.push({name:d[0],alias:d[1]||d[0],merge:a}))}return b};b.loading=function(a){!1===a?u=!1:"number"==typeof a?u=a?1:0:D=a;return b};b.method=function(a){e.method=a;return b};b.dataType=function(a){e.dataType=a;return b};b.header=function(a,c){e.header=e.header||{};switch(typeof a){case "string":e.header[a]=c;break;case "object":e.header=a}return b};b.contentType=function(a){!0===a?b.header("content-type","application/x-www-form-urlencoded"):"string"==typeof a?b.header("content-type",a):b.header("content-type","application/json");return b};b.cookie=function(a){"boolean"==typeof a?x=a:"string"==typeof a?requestCookie=a:x=!0;return b};b.sync=function(){e.async=!1;return b};b.get=function(a,c,d){b.run(a,c,d)};b.post=function(a,c,d){b.method("POST").run(a,c,d)};b.run=function(a,c,d){f&&(!l||0>requestQueue.indexOf(e.url))&&(q=a||q,r=c||r,t=d||t,x&&requestCookie&&b.header("cookie",requestCookie),1===u?wx.showNavigationBarLoading():0===u&&wx.showLoading({title:D}),B&&(b.removeParam(k),b.param("timestamp",parseInt((new Date).getTime()/1E3)),a=b.getParam(),a=JSON.stringify(a),a=hexMd5(a),a=hexMd5(a+Config.signSecret),b.param(k,a)),requestQueue.push(e.url),wx.request(e))};(function(){var a=w(),c;for(c in a)b.param(c,a[c])})();(function(){e.success=function(a){F(a.data);var c=a.data;if(l&&null!=c&&"object"==typeof c){var d=c.page?c.page:g,e=c.pageSize?c.pageSize:m;"function"==typeof A?A(c,d,e)?b.page(d+1):f=!1:c.totalPage||c.data?c.totalPage<=d||c.data&&c.data.length<e?f=!1:b.page(d+1):b.page(d+1)}"function"==typeof q&&q(a.data,a,b)};e.fail=function(a){"function"==typeof r&&r(a,b)};e.complete=function(a){requestCookie=a.header?a.header["Set-Cookie"]:"";requestQueue.splice(requestQueue.indexOf(e.url),1);"function"==typeof t&&t(a,b);0>=requestQueue.length&&(wx.hideNavigationBarLoading(),wx.hideLoading())}})();b.contentType(G);b.url(E);return b};